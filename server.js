// LINE Bot Server for Meeting Room Booking System
// Node.js + Express + LINE Messaging API

const express = require('express');
const line = require('@line/bot-sdk');
const bodyParser = require('body-parser');

const app = express();
const port = process.env.PORT || 3000;

// LINE Bot Configuration
const config = {
  channelAccessToken: process.env.CHANNEL_ACCESS_TOKEN,
  channelSecret: process.env.CHANNEL_SECRET // ‡πÉ‡∏™‡πà Channel Secret ‡∏à‡∏≤‡∏Å LINE Developers
};

const client = new line.Client(config);

// ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°
const rooms = [
  { id: 1, name: '‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÉ‡∏´‡∏ç‡πà', capacity: 20, color: '#4285F4' },
  { id: 2, name: '‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÄ‡∏•‡πá‡∏Å', capacity: 8, color: '#34A853' },
  { id: 3, name: '‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏Å‡∏•‡∏≤‡∏á', capacity: 12, color: '#9C27B0' }
];

// ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ä‡πâ MongoDB/PostgreSQL)
let bookings = [];
let userSessions = {}; // ‡πÄ‡∏Å‡πá‡∏ö session ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô

app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));

// Webhook endpoint ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å LINE
app.post('/webhook', line.middleware(config), (req, res) => {
  Promise.all(req.body.events.map(handleEvent))
    .then((result) => res.json(result))
    .catch((err) => {
      console.error(err);
      res.status(500).end();
    });
});

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Event
async function handleEvent(event) {
  if (event.type !== 'message' && event.type !== 'postback') {
    return Promise.resolve(null);
  }

  const userId = event.source.userId;
  
  // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Postback (‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°)
  if (event.type === 'postback') {
    return handlePostback(event);
  }

  // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
  const message = event.message.text.toLowerCase().trim();

  switch (message) {
    case '‡∏à‡∏≠‡∏á':
    case 'book':
    case 'booking':
      return showRoomSelection(userId);
    
    case '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞':
    case 'status':
      return showRoomStatus(userId);
    
    case '‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô':
    case 'mybooking':
      return showMyBookings(userId);
    
    case 'help':
    case '‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠':
      return showHelp(userId);
    
    default:
      return handleBookingFlow(userId, message);
  }
}

// ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Postback Actions
async function handlePostback(event) {
  const userId = event.source.userId;
  const data = event.postback.data;
  
  if (data.startsWith('room_')) {
    const roomId = parseInt(data.split('_')[1]);
    return startBookingProcess(userId, roomId);
  }
  
  if (data.startsWith('cancel_')) {
    const bookingId = data.split('_')[1];
    return cancelBooking(userId, bookingId);
  }
  
  if (data.startsWith('time_')) {
    const timeData = data.split('_');
    const startTime = timeData[1];
    const endTime = timeData[2];
    return selectTime(userId, startTime, endTime);
  }
}

// ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°
async function showRoomSelection(userId) {
  const flexMessage = {
    type: 'flex',
    altText: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°',
    contents: {
      type: 'carousel',
      contents: rooms.map(room => ({
        type: 'bubble',
        hero: {
          type: 'box',
          layout: 'vertical',
          contents: [
            {
              type: 'text',
              text: room.name,
              weight: 'bold',
              size: 'xl',
              color: '#ffffff'
            }
          ],
          backgroundColor: room.color,
          paddingAll: '20px'
        },
        body: {
          type: 'box',
          layout: 'vertical',
          contents: [
            {
              type: 'box',
              layout: 'horizontal',
              contents: [
                {
                  type: 'text',
                  text: 'üë• ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏:',
                  size: 'sm',
                  color: '#666666'
                },
                {
                  type: 'text',
                  text: `${room.capacity} ‡∏Ñ‡∏ô`,
                  size: 'sm',
                  weight: 'bold',
                  flex: 1
                }
              ]
            },
            {
              type: 'box',
              layout: 'horizontal',
              contents: [
                {
                  type: 'text',
                  text: 'üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:',
                  size: 'sm',
                  color: '#666666'
                },
                {
                  type: 'text',
                  text: getRoomStatusText(room.id),
                  size: 'sm',
                  weight: 'bold',
                  color: getRoomStatusColor(room.id),
                  flex: 1
                }
              ]
            }
          ],
          spacing: 'md'
        },
        footer: {
          type: 'box',
          layout: 'vertical',
          contents: [
            {
              type: 'button',
              style: 'primary',
              height: 'sm',
              action: {
                type: 'postback',
                label: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ',
                data: `room_${room.id}`
              }
            }
          ]
        }
      }))
    }
  };

  return client.replyMessage(userId, flexMessage);
}

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
async function startBookingProcess(userId, roomId) {
  const room = rooms.find(r => r.id === roomId);
  
  // ‡πÄ‡∏Å‡πá‡∏ö session
  userSessions[userId] = {
    step: 'date',
    roomId: roomId
  };

  const replyMessage = {
    type: 'text',
    text: `üìÖ ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${room.name}\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á:\n\n‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:\n- ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ\n- ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ\n- 25/09/2567\n- 2024-09-25`,
    quickReply: {
      items: [
        {
          type: 'action',
          action: {
            type: 'message',
            label: '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ',
            text: '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ'
          }
        },
        {
          type: 'action',
          action: {
            type: 'message',
            label: '‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ',
            text: '‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ'
          }
        }
      ]
    }
  };

  return client.replyMessage(userId, replyMessage);
}

// ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
async function handleBookingFlow(userId, message) {
  const session = userSessions[userId];
  if (!session) {
    return showHelp(userId);
  }

  switch (session.step) {
    case 'date':
      return handleDateInput(userId, message);
    case 'time':
      return handleTimeSelection(userId);
    case 'title':
      return handleTitleInput(userId, message);
    case 'organizer':
      return handleOrganizerInput(userId, message);
    default:
      return showHelp(userId);
  }
}

// ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
async function handleDateInput(userId, message) {
  let date;
  const today = new Date();
  
  if (message === '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ') {
    date = today.toISOString().split('T')[0];
  } else if (message === '‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ') {
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    date = tomorrow.toISOString().split('T')[0];
  } else {
    // Parse date format
    date = parseDateString(message);
    if (!date) {
      return client.replyMessage(userId, {
        type: 'text',
        text: '‚ùå ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà:\n\n‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:\n- ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ\n- ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ\n- 25/09/2567\n- 2024-09-25'
      });
    }
  }

  // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó session
  userSessions[userId].date = date;
  userSessions[userId].step = 'time';

  return showTimeSelection(userId);
}

// ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤
async function showTimeSelection(userId) {
  const session = userSessions[userId];
  const availableSlots = getAvailableTimeSlots(session.roomId, session.date);

  if (availableSlots.length === 0) {
    return client.replyMessage(userId, {
      type: 'text',
      text: '‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô'
    });
  }

  const quickReplyItems = availableSlots.slice(0, 10).map(slot => ({
    type: 'action',
    action: {
      type: 'postback',
      label: `${slot.start}-${slot.end}`,
      data: `time_${slot.start}_${slot.end}`
    }
  }));

  const replyMessage = {
    type: 'text',
    text: `‚è∞ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatDate(session.date)}):`,
    quickReply: {
      items: quickReplyItems
    }
  };

  return client.replyMessage(userId, replyMessage);
}

// ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤
async function selectTime(userId, startTime, endTime) {
  userSessions[userId].startTime = startTime;
  userSessions[userId].endTime = endTime;
  userSessions[userId].step = 'title';

  return client.replyMessage(userId, {
    type: 'text',
    text: 'üìù ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°:'
  });
}

// ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠
async function handleTitleInput(userId, message) {
  userSessions[userId].title = message;
  userSessions[userId].step = 'organizer';

  return client.replyMessage(userId, {
    type: 'text',
    text: 'üë§ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á:'
  });
}

// ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á
async function handleOrganizerInput(userId, message) {
  const session = userSessions[userId];
  session.organizer = message;

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
  const booking = {
    id: Date.now().toString(),
    userId: userId,
    roomId: session.roomId,
    title: session.title,
    organizer: session.organizer,
    date: session.date,
    startTime: session.startTime,
    endTime: session.endTime,
    status: 'confirmed'
  };

  bookings.push(booking);

  // ‡∏•‡∏ö session
  delete userSessions[userId];

  // ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
  return sendBookingConfirmation(userId, booking);
}

// ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
async function sendBookingConfirmation(userId, booking) {
  const room = rooms.find(r => r.id === booking.roomId);
  
  const flexMessage = {
    type: 'flex',
    altText: '‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
    contents: {
      type: 'bubble',
      hero: {
        type: 'box',
        layout: 'vertical',
        contents: [
          {
            type: 'text',
            text: '‚úÖ ‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
            weight: 'bold',
            size: 'xl',
            color: '#ffffff'
          }
        ],
        backgroundColor: '#34A853',
        paddingAll: '20px'
      },
      body: {
        type: 'box',
        layout: 'vertical',
        contents: [
          {
            type: 'text',
            text: '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á',
            weight: 'bold',
            size: 'lg',
            margin: 'md'
          },
          {
            type: 'separator',
            margin: 'md'
          },
          {
            type: 'box',
            layout: 'vertical',
            contents: [
              createDetailRow('üÜî ‡∏£‡∏´‡∏±‡∏™‡∏à‡∏≠‡∏á:', booking.id),
              createDetailRow('üè¢ ‡∏´‡πâ‡∏≠‡∏á:', room.name),
              createDetailRow('üìã ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠:', booking.title),
              createDetailRow('üë§ ‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á:', booking.organizer),
              createDetailRow('üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:', formatDate(booking.date)),
              createDetailRow('‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤:', `${booking.startTime} - ${booking.endTime}`)
            ],
            spacing: 'sm',
            margin: 'md'
          }
        ]
      },
      footer: {
        type: 'box',
        layout: 'vertical',
        contents: [
          {
            type: 'button',
            style: 'secondary',
            height: 'sm',
            action: {
              type: 'postback',
              label: '‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á',
              data: `cancel_${booking.id}`
            }
          }
        ]
      }
    }
  };

  return client.replyMessage(userId, flexMessage);
}

// ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°
async function showRoomStatus(userId) {
  const today = new Date().toISOString().split('T')[0];
  
  const statusMessage = rooms.map(room => {
    const todayBookings = bookings.filter(b => 
      b.roomId === room.id && 
      b.date === today && 
      b.status === 'confirmed'
    );

    let status = `üè¢ *${room.name}* (${room.capacity} ‡∏Ñ‡∏ô)\n`;
    
    if (todayBookings.length === 0) {
      status += '‚úÖ ‡∏ß‡πà‡∏≤‡∏á ‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô\n';
    } else {
      status += `üìä ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á ${todayBookings.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:\n`;
      todayBookings.forEach(booking => {
        status += `‚Ä¢ ${booking.startTime}-${booking.endTime} ${booking.title}\n`;
      });
    }
    
    return status;
  }).join('\n');

  return client.replyMessage(userId, {
    type: 'text',
    text: `üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (${formatDate(today)}):\n\n${statusMessage}`
  });
}

// ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
async function showMyBookings(userId) {
  const myBookings = bookings.filter(b => b.userId === userId && b.status === 'confirmed');

  if (myBookings.length === 0) {
    return client.replyMessage(userId, {
      type: 'text',
      text: 'üìã ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°'
    });
  }

  const bookingList = myBookings.map(booking => {
    const room = rooms.find(r => r.id === booking.roomId);
    return `üÜî ${booking.id}\nüè¢ ${room.name}\nüìã ${booking.title}\nüìÖ ${formatDate(booking.date)}\n‚è∞ ${booking.startTime}-${booking.endTime}\n`;
  }).join('\n---\n');

  return client.replyMessage(userId, {
    type: 'text',
    text: `üìã ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:\n\n${bookingList}`
  });
}

// ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
async function cancelBooking(userId, bookingId) {
  const booking = bookings.find(b => b.id === bookingId && b.userId === userId);
  
  if (!booking) {
    return client.replyMessage(userId, {
      type: 'text',
      text: '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
    });
  }

  booking.status = 'cancelled';

  return client.replyMessage(userId, {
    type: 'text',
    text: `‚úÖ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\n‡∏£‡∏´‡∏±‡∏™‡∏à‡∏≠‡∏á: ${bookingId}`
  });
}

// ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠
async function showHelp(userId) {
  const helpMessage = {
    type: 'text',
    text: `ü§ñ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°:\n\nüí¨ ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á:\n‚Ä¢ "‡∏à‡∏≠‡∏á" - ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°\n‚Ä¢ "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞" - ‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡πâ‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ\n‚Ä¢ "‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô" - ‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì\n‚Ä¢ "‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠" - ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ\n\nüìû ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: IT Support`,
    quickReply: {
      items: [
        {
          type: 'action',
          action: {
            type: 'message',
            label: 'üè¢ ‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á',
            text: '‡∏à‡∏≠‡∏á'
          }
        },
        {
          type: 'action',
          action: {
            type: 'message',
            label: 'üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞',
            text: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'
          }
        }
      ]
    }
  };

  return client.replyMessage(userId, helpMessage);
}

// Helper Functions

function createDetailRow(label, value) {
  return {
    type: 'box',
    layout: 'horizontal',
    contents: [
      {
        type: 'text',
        text: label,
        size: 'sm',
        color: '#666666',
        flex: 2
      },
      {
        type: 'text',
        text: value,
        size: 'sm',
        weight: 'bold',
        flex: 3,
        wrap: true
      }
    ]
  };
}

function getRoomStatusText(roomId) {
  const today = new Date().toISOString().split('T')[0];
  const todayBookings = bookings.filter(b => 
    b.roomId === roomId && 
    b.date === today && 
    b.status === 'confirmed'
  );
  
  return todayBookings.length === 0 ? '‡∏ß‡πà‡∏≤‡∏á' : `‡∏à‡∏≠‡∏á ${todayBookings.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
}

function getRoomStatusColor(roomId) {
  const today = new Date().toISOString().split('T')[0];
  const todayBookings = bookings.filter(b => 
    b.roomId === roomId && 
    b.date === today && 
    b.status === 'confirmed'
  );
  
  return todayBookings.length === 0 ? '#34A853' : '#EA4335';
}

function getAvailableTimeSlots(roomId, date) {
  const timeSlots = [
    { start: '08:00', end: '09:00' },
    { start: '09:00', end: '10:00' },
    { start: '10:00', end: '11:00' },
    { start: '11:00', end: '12:00' },
    { start: '13:00', end: '14:00' },
    { start: '14:00', end: '15:00' },
    { start: '15:00', end: '16:00' },
    { start: '16:00', end: '17:00' }
  ];

  const roomBookings = bookings.filter(b => 
    b.roomId === roomId && 
    b.date === date && 
    b.status === 'confirmed'
  );

  return timeSlots.filter(slot => {
    return !roomBookings.some(booking => 
      slot.start < booking.endTime && slot.end > booking.startTime
    );
  });
}

function parseDateString(dateStr) {
  // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö DD/MM/YYYY ‡πÅ‡∏•‡∏∞ YYYY-MM-DD
  const formats = [
    /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/, // DD/MM/YYYY
    /^(\d{4})-(\d{1,2})-(\d{1,2})$/   // YYYY-MM-DD
  ];

  for (let format of formats) {
    const match = dateStr.match(format);
    if (match) {
      if (format === formats[0]) {
        // DD/MM/YYYY
        const [, day, month, year] = match;
        return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
      } else {
        // YYYY-MM-DD
        return dateStr;
      }
    }
  }
  return null;
}

function formatDate(dateStr) {
  const date = new Date(dateStr);
  const options = { 
    year: 'numeric', 
    month: 'short', 
    day: 'numeric',
    weekday: 'short'
  };
  return date.toLocaleDateString('th-TH', options);
}

// Start server
app.listen(port, () => {
  console.log(`üöÄ LINE Bot server running on port ${port}`);
  console.log(`üìû Webhook URL: https://your-domain.com/webhook`);
});

// Export for serverless deployment
module.exports = app;